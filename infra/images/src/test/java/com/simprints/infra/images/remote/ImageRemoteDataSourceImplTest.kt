package com.simprints.infra.images.remote

import androidx.test.ext.junit.runners.AndroidJUnit4
import com.google.firebase.storage.FirebaseStorage
import com.simprints.infra.config.sync.ConfigManager
import com.simprints.infra.images.model.SecuredImageRef
import io.mockk.coEvery
import io.mockk.every
import io.mockk.mockk
import io.mockk.mockkStatic
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.test.runTest
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import java.io.FileInputStream

@Suppress("DEPRECATION")
@RunWith(AndroidJUnit4::class)
class ImageRemoteDataSourceImplTest {

    @Before
    fun setup() {
        // We need to mock statics and global extensions
        mockkStatic(FirebaseStorage::class)
        mockkStatic("kotlinx.coroutines.tasks.TasksKt")
    }


    @Test
    fun `test image upload flow`() = runTest {

        val imgUrlProviderMock = mockk<ConfigManager> {
            coEvery { getProject(any()).imageBucket } returns "gs://`simprints-dev.appspot.com"
        }

        val authStoreMock = mockk<com.simprints.infra.authstore.AuthStore>(relaxed = true) {
            every { getLegacyAppFallback() } returns mockk(relaxed = true)
            every { getLegacyAppFallback().options.projectId } returns "projectId"
            every { signedInProjectId } returns "projectId"
        }

        val storageMock = setupStoragemockk()

        every { FirebaseStorage.getInstance(any(), any()) } returns storageMock

        val remoteDataSource = ImageRemoteDataSourceImpl(imgUrlProviderMock, authStoreMock)
        val imageStreamMock = mockk<FileInputStream>(relaxed = true)

        val securedImageRefMock = mockk<SecuredImageRef>(relaxed = true) {
            every { relativePath.parts } returns arrayOf("Test1")
        }

        val result = remoteDataSource.uploadImage(imageStreamMock, securedImageRefMock)

        assert(result.isUploadSuccessful())
    }

    @Test
    fun `null project returns failed upload`() = runTest {

        val imgUrlProviderMock = mockk<ConfigManager>()

        val authStoreMock = mockk<com.simprints.infra.authstore.AuthStore>(relaxed = true) {
            every { getLegacyAppFallback().options.projectId } returns null
        }

        val remoteDataSource = ImageRemoteDataSourceImpl(imgUrlProviderMock, authStoreMock)
        val rtn = remoteDataSource.uploadImage(mockk(), mockk())

        assert(!rtn.isUploadSuccessful())
    }

    @Test
    fun `null storage bucket returns failed upload`() = runTest {

        val imgUrlProviderMock = mockk<ConfigManager> {
            coEvery { getProject(any()).imageBucket } returns ""
        }

        val authStoreMock = mockk<com.simprints.infra.authstore.AuthStore>(relaxed = true) {
            every { getLegacyAppFallback().options.projectId } returns "projectId"
        }

        val remoteDataSource = ImageRemoteDataSourceImpl(imgUrlProviderMock, authStoreMock)
        val rtn = remoteDataSource.uploadImage(mockk(), mockk())

        assert(!rtn.isUploadSuccessful())
    }

    private fun setupStoragemockk() = mockk<FirebaseStorage>(relaxed = true) {
        every { reference } returns mockk {
            every { child(any()) } returns mockk {
                every { path } returns "testPath"
                every { putStream(any()) } returns mockk {
                    coEvery { await() } returns mockk {
                        every { task } returns mockk {
                            every { isSuccessful } returns true
                        }
                    }
                }
            }
        }
    }

}
